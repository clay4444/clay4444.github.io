<!DOCTYPE html>
<html lang="chinese">
    <!-- title -->




<!-- keywords -->




<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="clay">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="clay">
    
    <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content="I'll do every thing for GTR">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Flink源码解析之任务的调度与执行 · 十年饮冰，难凉热血</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/clay4444.github.io/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href="/clay4444.github.io/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="/clay4444.github.io/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href="/clay4444.github.io/assets/favicon.ico">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script">
    <link rel="preload" href="/clay4444.github.io/scripts/main.js" as="script">
    <link rel="preload" as="font" href="/clay4444.github.io/font/Oswald-Regular.ttf" crossorigin="">
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin="">
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/clay4444.github.io/">诚觉世事尽可原谅.</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">Flink源码解析之任务的调度与执行</a>
            </div>
    </div>
    
    <a class="home-link" href="/clay4444.github.io/">诚觉世事尽可原谅.</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:50vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/clay4444.github.io/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            Flink源码解析之任务的调度与执行
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class="post-intro-tags">
    
        <a class="post-tag" href="javascript:void(0);" data-tags="Flink">Flink</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">8.9k</span>阅读时长: <span class="post-count reading-time">40 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2019/06/06</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/clay4444.github.io/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/clay4444.github.io/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h2 id="任务的调度与执行"><a href="#任务的调度与执行" class="headerlink" title="任务的调度与执行"></a>任务的调度与执行</h2><p>关于flink的任务执行架构，官网的这两张图就是最好的说明：</p>
<img src="/clay4444.github.io/posts/149d881d/一.jpg">
<p>Flink 集群启动后，首先会启动一个 JobManger 和多个的 TaskManager。用户的代码会由 JobClient 提交给 JobManager，JobManager 再把来自不同用户的任务发给 不同的 TaskManager 去执行，每个TaskManager管理着多个task，task是执行计算的最小结构， TaskManager 将心跳和统计信息汇报给 JobManager。TaskManager 之间以流的形式进行 数据的传输。上述除了task外的三者均为独立的 JVM 进程。 要注意的是，TaskManager和job并非一一对应的关系。flink调度的最小单元是task而非 TaskManager，也就是说，来自不同job的不同task可能运行于同一个TaskManager的不同 线程上。</p>
<img src="/clay4444.github.io/posts/149d881d/二.jpg">
<p>一个flink任务所有可能的状态如上图所示。图上画的很明白，就不再赘述了。</p>
<p><br></p>
<h3 id="1-计算资源的调度"><a href="#1-计算资源的调度" class="headerlink" title="1.计算资源的调度"></a>1.计算资源的调度</h3><p>Task slot是一个TaskManager内资源分配的最小载体，代表了一个固定大小的资源子集，每 个TaskManager会将其所占有的资源平分给它的slot。 通过调整 task slot 的数量，用户可以定义task之间是如何相互隔离的。每个 TaskManager 有一个slot，也就意味着每个task运行在独立的 JVM 中。每个 TaskManager 有多个slot的 话，也就是说多个task运行在同一个JVM中。 而在同一个JVM进程中的task，可以共享TCP连接（基于多路复用）和心跳消息，可以减少数 据的网络传输，也能共享一些数据结构，一定程度上减少了每个task的消耗。</p>
<p>每个slot可以接受单个task，也可以接受多个连续task组成的pipeline，如下图所 示，FlatMap函数占用一个taskslot，而key Agg函数和sink函数共用一个taskslot：</p>
<img src="/clay4444.github.io/posts/149d881d/三.jpg">
<p>为了达到共用slot的目的，除了可以以chain的方式pipeline算子，我们还可以允许 SlotSharingGroup，如下图所示：</p>
<img src="/clay4444.github.io/posts/149d881d/四.jpg">
<p>我们可以把不能被chain成一条的两个操作如flatmap和key&amp;sink放在一个TaskSlot里执行， 这样做可以获得以下好处：</p>
<ul>
<li>共用slot使得我们不再需要计算每个任务需要的总task数目，直接取最高算子的并行度即可</li>
<li>对计算资源的利用率更高。例如，通常的轻量级操作map和重量级操作Aggregate不再分 别需要一个线程，而是可以在同一个线程内执行，而且对于slot有限的场景，我们可以增 大每个task的并行度了。</li>
</ul>
<p>接下来我们还是用官网的图来说明flink是如何重用slot的：</p>
<img src="/clay4444.github.io/posts/149d881d/五.jpg">
<ol>
<li>TaskManager1分配一个SharedSlot0</li>
<li>把source task放入一个SimpleSlot0，再把该slot放入SharedSlot0</li>
<li>把flatmap task放入一个SimpleSlot1，再把该slot放入SharedSlot0</li>
<li>因为我们的flatmap task并行度是2，因此不能再放入SharedSlot0，所以向 TaskMange21申请了一个新的SharedSlot0</li>
<li>把第二个flatmap task放进一个新的SimpleSlot，并放进TaskManager2的 SharedSlot0</li>
<li>开始处理key&amp;sink task，因为其并行度也是2，所以先把第一个task放进 TaskManager1的SharedSlot</li>
<li>把第二个key&amp;sink放进TaskManager2的SharedSlot</li>
</ol>
<p><br></p>
<h3 id="2-JobManager执行job"><a href="#2-JobManager执行job" class="headerlink" title="2.JobManager执行job"></a>2.JobManager执行job</h3><p>JobManager负责接收 flink 的作业，调度 task，收集 job 的状态、管理 TaskManagers。被实现为一个 akka actor。</p>
<p><br></p>
<h4 id="2-1-JobManager的组件"><a href="#2-1-JobManager的组件" class="headerlink" title="2.1 JobManager的组件"></a>2.1 JobManager的组件</h4><ul>
<li>BlobServer 是一个用来管理二进制大文件的服务，比如保存用户上传的jar文件，该服务会将其写到磁盘上。还有一些相关的类，如BlobCache，用于TaskManager向JobManager 下载用户的jar文件，</li>
<li>InstanceManager 用来管理当前存活的TaskManager的组件，记录了TaskManager的心跳信息等</li>
<li>CompletedCheckpointStore 用于保存已完成的checkpoint相关信息，持久化到内存中或者zookeeper上</li>
<li>MemoryArchivist 保存了已经提交到flink的作业的相关信息，如JobGraph等</li>
</ul>
<p><br></p>
<h4 id="2-2-JobManager的启动过程"><a href="#2-2-JobManager的启动过程" class="headerlink" title="2.2 JobManager的启动过程"></a>2.2 JobManager的启动过程</h4><p>先列出JobManager启动的核心代码</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runJobManager</span></span>(</span><br><span class="line">    configuration: <span class="type">Configuration</span>,</span><br><span class="line">    executionMode: <span class="type">JobManagerMode</span>,</span><br><span class="line">    listeningAddress: <span class="type">String</span>,</span><br><span class="line">    listeningPort: <span class="type">Int</span>)</span><br><span class="line">: <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> numberProcessors = <span class="type">Hardware</span>.getNumberCPUCores()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> futureExecutor = <span class="type">Executors</span>.newScheduledThreadPool(</span><br><span class="line">        numberProcessors,</span><br><span class="line">        <span class="keyword">new</span> <span class="type">ExecutorThreadFactory</span>(<span class="string">"jobmanager-future"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ioExecutor = <span class="type">Executors</span>.newFixedThreadPool(</span><br><span class="line">        numberProcessors,</span><br><span class="line">        <span class="keyword">new</span> <span class="type">ExecutorThreadFactory</span>(<span class="string">"jobmanager-io"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> timeout = <span class="type">AkkaUtils</span>.getTimeout(configuration)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we have to first start the JobManager ActorSystem because this determines the port if 0</span></span><br><span class="line">    <span class="comment">// was chosen before. The method startActorSystem will update the configuration correspondingly.</span></span><br><span class="line">    <span class="keyword">val</span> jobManagerSystem = startActorSystem(</span><br><span class="line">        configuration,</span><br><span class="line">        listeningAddress,</span><br><span class="line">        listeningPort)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> highAvailabilityServices = <span class="type">HighAvailabilityServicesUtils</span>.createHighAvailabilityServices(</span><br><span class="line">        configuration,</span><br><span class="line">        ioExecutor,</span><br><span class="line">        <span class="type">AddressResolution</span>.<span class="type">NO_ADDRESS_RESOLUTION</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> metricRegistry = <span class="keyword">new</span> <span class="type">MetricRegistryImpl</span>(</span><br><span class="line">        <span class="type">MetricRegistryConfiguration</span>.fromConfiguration(configuration))</span><br><span class="line"></span><br><span class="line">    metricRegistry.startQueryService(jobManagerSystem, <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> (_, _, webMonitorOption, _) = <span class="keyword">try</span> &#123;</span><br><span class="line">        startJobManagerActors(</span><br><span class="line">            jobManagerSystem,</span><br><span class="line">            configuration,</span><br><span class="line">            executionMode,</span><br><span class="line">            listeningAddress,</span><br><span class="line">            futureExecutor,</span><br><span class="line">            ioExecutor,</span><br><span class="line">            highAvailabilityServices,</span><br><span class="line">            metricRegistry,</span><br><span class="line">            classOf[<span class="type">JobManager</span>],</span><br><span class="line">            classOf[<span class="type">MemoryArchivist</span>],</span><br><span class="line">            <span class="type">Option</span>(classOf[<span class="type">StandaloneResourceManager</span>])</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> t: <span class="type">Throwable</span> =&gt;</span><br><span class="line">        futureExecutor.shutdownNow()</span><br><span class="line">        ioExecutor.shutdownNow()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> t</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block until everything is shut down</span></span><br><span class="line">    jobManagerSystem.awaitTermination()</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>配置Akka并生成ActorSystem，启动JobManager</li>
<li>启动HA和metric相关服务</li>
<li>在 startJobManagerActors() 方法中启动JobManagerActors，以及 webserver，TaskManagerActor，ResourceManager等等</li>
<li>阻塞等待终止</li>
<li>集群通过LeaderService等选出JobManager的leader</li>
</ul>
<p><br></p>
<h4 id="2-3-JobManager启动Task"><a href="#2-3-JobManager启动Task" class="headerlink" title="2.3 JobManager启动Task"></a>2.3 JobManager启动Task</h4><p>JobManager 是一个Actor，通过各种消息来完成核心逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">override def handleMessage: Receive = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">GrantLeadership</span><span class="params">(newLeaderSessionID)</span> </span>=&gt;</span><br><span class="line">        log.info(s<span class="string">"JobManager $getAddress was granted leadership with leader session ID "</span> +</span><br><span class="line">                 s<span class="string">"$newLeaderSessionID."</span>)</span><br><span class="line"></span><br><span class="line">        leaderSessionID = newLeaderSessionID</span><br><span class="line">        .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有几个比较重要的消息：</p>
<ul>
<li>GrantLeadership 获得leader授权，将自身被分发到的 session id 写到 zookeeper，并 恢复所有的 jobs</li>
<li>RevokeLeadership 剥夺leader授权，打断清空所有的 job 信息，但是保留作业缓存，注 销所有的 TaskManagers</li>
<li>RegisterTaskManagers 注册 TaskManager，如果之前已经注册过，则只给对应的 Instance 发送消息，否则启动注册逻辑：在 InstanceManager 中注册该 Instance 的信 息，并停止 Instance BlobLibraryCacheManager 的端口【供下载 lib 包用】，同时使用 watch 监听 task manager 的存活</li>
<li>SubmitJob 提交 jobGraph</li>
</ul>
<p>最后一项SubmintJob就是我们要关注的，从客户端收到JobGraph，转换为ExecutionGraph并执行的过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> def <span class="title">submitJob</span><span class="params">(jobGraph: JobGraph, jobInfo: JobInfo, isRecovery: Boolean = <span class="keyword">false</span>)</span>: Unit </span>= &#123;</span><br><span class="line">    	....</span><br><span class="line">        <span class="comment">// 构建 executionGraph</span></span><br><span class="line">        executionGraph = ExecutionGraphBuilder.buildGraph(</span><br><span class="line">          executionGraph,</span><br><span class="line">          jobGraph,</span><br><span class="line">          flinkConfiguration,</span><br><span class="line">          futureExecutor,</span><br><span class="line">          ioExecutor,</span><br><span class="line">          scheduler,</span><br><span class="line">          userCodeLoader,</span><br><span class="line">          checkpointRecoveryFactory,</span><br><span class="line">          Time.of(timeout.length, timeout.unit),</span><br><span class="line">          restartStrategy,</span><br><span class="line">          jobMetrics,</span><br><span class="line">          numSlots,</span><br><span class="line">          blobServer,</span><br><span class="line">          Time.milliseconds(allocationTimeout),</span><br><span class="line">          log.logger)</span><br><span class="line">        </span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (leaderSessionID.isDefined &amp;&amp;</span><br><span class="line">            <span class="comment">// 最后如果确认本JobManager是leader，则执行 executionGraph.scheduleForExecution() 方法</span></span><br><span class="line">            leaderElectionService.hasLeadership(leaderSessionID.get)) &#123;</span><br><span class="line">            <span class="comment">// There is a small chance that multiple job managers schedule the same job after if</span></span><br><span class="line">            <span class="comment">// they try to recover at the same time. This will eventually be noticed, but can not be</span></span><br><span class="line">            <span class="comment">// ruled out from the beginning.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> Scheduling the job for execution is a separate action from the job submission.</span></span><br><span class="line">            <span class="comment">// The success of submitting the job must be independent from the success of scheduling</span></span><br><span class="line">            <span class="comment">// the job.</span></span><br><span class="line">            log.info(s<span class="string">"Scheduling job $jobId ($jobName)."</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// executionGraph 真正执行的地方</span></span><br><span class="line">            executionGraph.scheduleForExecution()</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Remove the job graph. Otherwise it will be lingering around and possibly removed from</span></span><br><span class="line">            <span class="comment">// ZooKeeper by this JM.</span></span><br><span class="line">            self ! decorateMessage(RemoveJob(jobId, removeJobFromStateBackend = <span class="keyword">false</span>))</span><br><span class="line"></span><br><span class="line">            log.warn(s<span class="string">"Submitted job $jobId, but not leader. The other leader needs to recover "</span> +</span><br><span class="line">              <span class="string">"this. I am not scheduling the job for execution."</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> t: Throwable =&gt; <span class="keyword">try</span> &#123;</span><br><span class="line">            executionGraph.failGlobal(t)</span><br><span class="line">          &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> tt: Throwable =&gt;</span><br><span class="line">              log.error(<span class="string">"Error while marking ExecutionGraph as failed."</span>, tt)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;(context.dispatcher)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>首先做一些准备工作，然后获取一个ExecutionGraph，判断是否是恢复的job，然后将job保 存下来，并且通知客户端本地已经提交成功了，最后如果确认本JobManager是leader，则执 行 executionGraph.scheduleForExecution() 方法，这个方法经过一系列调用，把每个 ExecutionVertex传递给了Excution类的deploy方法：</p>
<p><br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * executiongraph 执行的时候，最终调用到这里</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> JobException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span> <span class="keyword">throws</span> JobException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> LogicalSlot slot  = assignedResource;</span><br><span class="line"></span><br><span class="line">    checkNotNull(slot, <span class="string">"In order to deploy the execution we first have to assign a resource via tryAssignResource."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the TaskManager died in the meantime</span></span><br><span class="line">    <span class="comment">// This only speeds up the response to TaskManagers failing concurrently to deployments.</span></span><br><span class="line">    <span class="comment">// The more general check is the rpcTimeout of the deployment call</span></span><br><span class="line">    <span class="keyword">if</span> (!slot.isAlive()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Target slot (TaskManager) for deployment is no longer alive."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure exactly one deployment call happens from the correct state</span></span><br><span class="line">    <span class="comment">// note: the transition from CREATED to DEPLOYING is for testing purposes only</span></span><br><span class="line">    ExecutionState previous = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">if</span> (previous == SCHEDULED || previous == CREATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!transitionState(previous, DEPLOYING)) &#123;</span><br><span class="line">            <span class="comment">// race condition, someone else beat us to the deploying call.</span></span><br><span class="line">            <span class="comment">// this should actually not happen and indicates a race somewhere else</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot deploy task: Concurrent deployment call race."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// vertex may have been cancelled, or it was already scheduled</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The vertex must be in CREATED or SCHEDULED state to be deployed. Found state "</span> + previous);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> != slot.getPayload()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">            String.format(<span class="string">"The execution %s has not been assigned to the assigned slot."</span>, <span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// race double check, did we fail/cancel and do we need to release the slot?</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state != DEPLOYING) &#123;</span><br><span class="line">            slot.releaseSlot(<span class="keyword">new</span> FlinkException(<span class="string">"Actual state of execution "</span> + <span class="keyword">this</span> + <span class="string">" ("</span> + state + <span class="string">") does not match expected state DEPLOYING."</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOG.isInfoEnabled()) &#123;</span><br><span class="line">            LOG.info(String.format(<span class="string">"Deploying %s (attempt #%d) to %s"</span>, vertex.getTaskNameWithSubtaskIndex(),</span><br><span class="line">                                   attemptNumber, getAssignedResourceLocation().getHostname()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成了一个task部署的描述，交给 taskManagerGateway 去提交任务</span></span><br><span class="line">        <span class="keyword">final</span> TaskDeploymentDescriptor deployment = vertex.createDeploymentDescriptor(</span><br><span class="line">            attemptId,</span><br><span class="line">            slot,</span><br><span class="line">            taskRestore,</span><br><span class="line">            attemptNumber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// null taskRestore to let it be GC'ed</span></span><br><span class="line">        taskRestore = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskManagerGateway taskManagerGateway = slot.getTaskManagerGateway();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// taskManagerGateway 提交任务，剩下的就是taskmanager 执行task的范畴了；</span></span><br><span class="line">        <span class="keyword">final</span> CompletableFuture&lt;Acknowledge&gt; submitResultFuture = taskManagerGateway.submitTask(deployment, rpcTimeout);</span><br><span class="line"></span><br><span class="line">        submitResultFuture.whenCompleteAsync(</span><br><span class="line">            (ack, failure) -&gt; &#123;</span><br><span class="line">                <span class="comment">// only respond to the failure case</span></span><br><span class="line">                <span class="keyword">if</span> (failure != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (failure <span class="keyword">instanceof</span> TimeoutException) &#123;</span><br><span class="line">                        String taskname = vertex.getTaskNameWithSubtaskIndex() + <span class="string">" ("</span> + attemptId + <span class="string">')'</span>;</span><br><span class="line"></span><br><span class="line">                        markFailed(<span class="keyword">new</span> Exception(</span><br><span class="line">                            <span class="string">"Cannot deploy task "</span> + taskname + <span class="string">" - TaskManager ("</span> + getAssignedResourceLocation()</span><br><span class="line">                            + <span class="string">") not responding after a rpcTimeout of "</span> + rpcTimeout, failure));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        markFailed(failure);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            executor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        markFailed(t);</span><br><span class="line">        ExceptionUtils.rethrow(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们首先生成了一个TaskDeploymentDescriptor，然后交给 了 taskManagerGateway.submitTask() 方法执行。接下来的部分，就属于TaskManager的范畴了。</p>
<p><br></p>
<h3 id="3-TaskManager执行task"><a href="#3-TaskManager执行task" class="headerlink" title="3. TaskManager执行task"></a>3. TaskManager执行task</h3><p><br></p>
<h4 id="3-1-TaskManager的基本组件"><a href="#3-1-TaskManager的基本组件" class="headerlink" title="3.1 TaskManager的基本组件"></a>3.1 TaskManager的基本组件</h4><p>TaskManager是flink中资源管理的基本组件，是所有执行任务的基本容器，提供了内存管 理、IO管理、通信管理等一系列功能，本节对各个模块进行简要介绍。</p>
<ol>
<li>MemoryManager flink并没有把所有内存的管理都委托给JVM，因为JVM普遍存在着存储对象密度低、大内存时GC对系统影响大等问题。所以flink自己抽象了一套内存管理机制，将所有对象序列化后放在自己的MemorySegment上进行管理。MemoryManger涉及内容较多，将在后续章节进行继续剖析。</li>
<li>IOManager flink通过IOManager管理磁盘IO的过程，提供了同步和异步两种写模式，又进一步区分了block、buffer和bulk三种读写方式。</li>
</ol>
<p>IOManager提供了两种方式枚举磁盘文件，一种是直接遍历文件夹下所有文件，另一种是计数器方式，对每个文件名以递增顺序访问。</p>
<p>在底层，flink将文件IO抽象为FileIOChannle，封装了底层实现。</p>
<img src="/clay4444.github.io/posts/149d881d/六.jpg">
<p>可以看到，flink在底层实际上都是以异步的方式进行读写。</p>
<ol>
<li>NetworkEnvironment 是TaskManager的网络 IO 组件，包含了追踪中间结果和数据交换 的数据结构。它的构造器会统一将配置的内存先分配出来，抽象成 NetworkBufferPool 统一 管理内存的申请和释放。意思是说，在输入和输出数据时，不管是保留在本地内存，等待 chain在一起的下个操作符进行处理，还是通过网络把本操作符的计算结果发送出去，都被抽 象成了NetworkBufferPool。后续我们还将对这个组件进行详细分析。</li>
</ol>
<p><br></p>
<h4 id="3-2-TaskManager执行Task"><a href="#3-2-TaskManager执行Task" class="headerlink" title="3.2 TaskManager执行Task"></a>3.2 TaskManager执行Task</h4><p>对于TM来说，执行task就是把收到的 TaskDeploymentDescriptor 对象转换成一个task并执 行的过程。TaskDeploymentDescriptor这个类保存了task执行所必须的所有内容，例如序列 化的算子，输入的InputGate和输出的ResultPartition的定义，该task要作为几个subtask执 行等等。</p>
<p>按照正常逻辑思维，很容易想到TM的submitTask方法的行为：首先是确认资源，如寻找 JobManager和Blob，而后建立连接，解序列化算子，收集task相关信息，接下来就是创建一 个新的 Task 对象，这个task对象就是真正执行任务的关键所在。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">val task = <span class="keyword">new</span> Task(</span><br><span class="line">    jobInformation,</span><br><span class="line">    taskInformation,</span><br><span class="line">    tdd.getExecutionAttemptId,</span><br><span class="line">    tdd.getAllocationId,</span><br><span class="line">    tdd.getSubtaskIndex,</span><br><span class="line">    tdd.getAttemptNumber,</span><br><span class="line">    tdd.getProducedPartitions,</span><br><span class="line">    tdd.getInputGates,</span><br><span class="line">    tdd.getTargetSlotNumber,</span><br><span class="line">    memoryManager,</span><br><span class="line">    ioManager,</span><br><span class="line">    network,</span><br><span class="line">    bcVarManager,  <span class="comment">// 这个是管理广播变量的，广播变量是一类会被分发到每个任务中的共享变量</span></span><br><span class="line">    taskStateManager,</span><br><span class="line">    taskManagerConnection,</span><br><span class="line">    inputSplitProvider,</span><br><span class="line">    checkpointResponder,</span><br><span class="line">    blobCache,  <span class="comment">// 用于TaskManager向JobManager 下载用户的jar文件</span></span><br><span class="line">    libCache,   <span class="comment">// 下载lib 包</span></span><br><span class="line">    fileCache,</span><br><span class="line">    config,</span><br><span class="line">    taskMetricGroup,</span><br><span class="line">    resultPartitionConsumableNotifier,</span><br><span class="line">    partitionStateChecker,</span><br><span class="line">    context.dispatcher)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>如果读者是从头开始看这篇blog，里面有很多对象应该已经比较明确其作用了（除了那个 brVarManager，这个是管理广播变量的，广播变量是一类会被分发到每个任务中的共享变 量）。接下来的主要任务，就是把这个task启动起来,然后报告说已经启动task了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// all good, we kick off the task, which performs its own initialization</span></span><br><span class="line"><span class="comment">// 所有东西都准备好了，启动任务</span></span><br><span class="line">task.startTaskThread()</span><br><span class="line"></span><br><span class="line">sender ! decorateMessage(Acknowledge.get())</span><br></pre></td></tr></table></figure>
<p><br></p>
<h5 id="3-2-1-生成Task对象"><a href="#3-2-1-生成Task对象" class="headerlink" title="3.2.1 生成Task对象"></a>3.2.1 生成Task对象</h5><p>在执行new Task()方法时，第一步是把构造函数里的这些变量赋值给当前task的fields。</p>
<p>接下来是初始化ResultPartition和InputGate。这两个类描述了task的输出数据和输入数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 task</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Task</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    JobInformation jobInformation,</span></span></span><br><span class="line"><span class="function"><span class="params">    TaskInformation taskInformation,</span></span></span><br><span class="line"><span class="function"><span class="params">    ExecutionAttemptID executionAttemptID,</span></span></span><br><span class="line"><span class="function"><span class="params">    AllocationID slotAllocationId,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> subtaskIndex,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> attemptNumber,</span></span></span><br><span class="line"><span class="function"><span class="params">    Collection&lt;ResultPartitionDeploymentDescriptor&gt; resultPartitionDeploymentDescriptors,</span></span></span><br><span class="line"><span class="function"><span class="params">    Collection&lt;InputGateDeploymentDescriptor&gt; inputGateDeploymentDescriptors,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> targetSlotNumber,</span></span></span><br><span class="line"><span class="function"><span class="params">    MemoryManager memManager,</span></span></span><br><span class="line"><span class="function"><span class="params">    IOManager ioManager,</span></span></span><br><span class="line"><span class="function"><span class="params">    NetworkEnvironment networkEnvironment,</span></span></span><br><span class="line"><span class="function"><span class="params">    BroadcastVariableManager bcVarManager,</span></span></span><br><span class="line"><span class="function"><span class="params">    TaskStateManager taskStateManager,</span></span></span><br><span class="line"><span class="function"><span class="params">    TaskManagerActions taskManagerActions,</span></span></span><br><span class="line"><span class="function"><span class="params">    InputSplitProvider inputSplitProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">    CheckpointResponder checkpointResponder,</span></span></span><br><span class="line"><span class="function"><span class="params">    BlobCacheService blobService,</span></span></span><br><span class="line"><span class="function"><span class="params">    LibraryCacheManager libraryCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    FileCache fileCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    TaskManagerRuntimeInfo taskManagerConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nonnull TaskMetricGroup metricGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResultPartitionConsumableNotifier resultPartitionConsumableNotifier,</span></span></span><br><span class="line"><span class="function"><span class="params">    PartitionProducerStateChecker partitionProducerStateChecker,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor executor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Preconditions.checkNotNull(jobInformation);</span><br><span class="line">    Preconditions.checkNotNull(taskInformation);</span><br><span class="line"></span><br><span class="line">    Preconditions.checkArgument(<span class="number">0</span> &lt;= subtaskIndex, <span class="string">"The subtask index must be positive."</span>);</span><br><span class="line">    Preconditions.checkArgument(<span class="number">0</span> &lt;= attemptNumber, <span class="string">"The attempt number must be positive."</span>);</span><br><span class="line">    Preconditions.checkArgument(<span class="number">0</span> &lt;= targetSlotNumber, <span class="string">"The target slot number must be positive."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.taskInfo = <span class="keyword">new</span> TaskInfo(</span><br><span class="line">        taskInformation.getTaskName(),</span><br><span class="line">        taskInformation.getMaxNumberOfSubtaks(),</span><br><span class="line">        subtaskIndex,</span><br><span class="line">        taskInformation.getNumberOfSubtasks(),</span><br><span class="line">        attemptNumber,</span><br><span class="line">        String.valueOf(slotAllocationId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一步是把构造函数里的这些变量赋值给当前task的fields。</span></span><br><span class="line">    <span class="keyword">this</span>.jobId = jobInformation.getJobId();</span><br><span class="line">    <span class="keyword">this</span>.vertexId = taskInformation.getJobVertexId();</span><br><span class="line">    <span class="keyword">this</span>.executionId  = Preconditions.checkNotNull(executionAttemptID);</span><br><span class="line">    <span class="keyword">this</span>.allocationId = Preconditions.checkNotNull(slotAllocationId);</span><br><span class="line">    <span class="keyword">this</span>.taskNameWithSubtask = taskInfo.getTaskNameWithSubtasks();</span><br><span class="line">    <span class="keyword">this</span>.jobConfiguration = jobInformation.getJobConfiguration();</span><br><span class="line">    <span class="keyword">this</span>.taskConfiguration = taskInformation.getTaskConfiguration();</span><br><span class="line">    <span class="keyword">this</span>.requiredJarFiles = jobInformation.getRequiredJarFileBlobKeys();</span><br><span class="line">    <span class="keyword">this</span>.requiredClasspaths = jobInformation.getRequiredClasspathURLs();</span><br><span class="line">    <span class="keyword">this</span>.nameOfInvokableClass = taskInformation.getInvokableClassName();</span><br><span class="line">    <span class="keyword">this</span>.serializedExecutionConfig = jobInformation.getSerializedExecutionConfig();</span><br><span class="line"></span><br><span class="line">    Configuration tmConfig = taskManagerConfig.getConfiguration();</span><br><span class="line">    <span class="keyword">this</span>.taskCancellationInterval = tmConfig.getLong(TaskManagerOptions.TASK_CANCELLATION_INTERVAL);</span><br><span class="line">    <span class="keyword">this</span>.taskCancellationTimeout = tmConfig.getLong(TaskManagerOptions.TASK_CANCELLATION_TIMEOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.memoryManager = Preconditions.checkNotNull(memManager);</span><br><span class="line">    <span class="keyword">this</span>.ioManager = Preconditions.checkNotNull(ioManager);</span><br><span class="line">    <span class="keyword">this</span>.broadcastVariableManager = Preconditions.checkNotNull(bcVarManager);</span><br><span class="line">    <span class="keyword">this</span>.taskStateManager = Preconditions.checkNotNull(taskStateManager);</span><br><span class="line">    <span class="keyword">this</span>.accumulatorRegistry = <span class="keyword">new</span> AccumulatorRegistry(jobId, executionId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.inputSplitProvider = Preconditions.checkNotNull(inputSplitProvider);</span><br><span class="line">    <span class="keyword">this</span>.checkpointResponder = Preconditions.checkNotNull(checkpointResponder);</span><br><span class="line">    <span class="keyword">this</span>.taskManagerActions = checkNotNull(taskManagerActions);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.blobService = Preconditions.checkNotNull(blobService);</span><br><span class="line">    <span class="keyword">this</span>.libraryCache = Preconditions.checkNotNull(libraryCache);</span><br><span class="line">    <span class="keyword">this</span>.fileCache = Preconditions.checkNotNull(fileCache);</span><br><span class="line">    <span class="keyword">this</span>.network = Preconditions.checkNotNull(networkEnvironment);</span><br><span class="line">    <span class="keyword">this</span>.taskManagerConfig = Preconditions.checkNotNull(taskManagerConfig);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.taskExecutionStateListeners = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.metrics = metricGroup;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.partitionProducerStateChecker = Preconditions.checkNotNull(partitionProducerStateChecker);</span><br><span class="line">    <span class="keyword">this</span>.executor = Preconditions.checkNotNull(executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the reader and writer structures</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String taskNameWithSubtaskAndId = taskNameWithSubtask + <span class="string">" ("</span> + executionId + <span class="string">')'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Produced intermediate result partitions</span></span><br><span class="line">    <span class="keyword">this</span>.producedPartitions = <span class="keyword">new</span> ResultPartition[resultPartitionDeploymentDescriptors.size()];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接下来是初始化ResultPartition和InputGate。这两个类描述了task的输出数据和输入数据。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ResultPartitionDeploymentDescriptor desc: resultPartitionDeploymentDescriptors) &#123;</span><br><span class="line">        ResultPartitionID partitionId = <span class="keyword">new</span> ResultPartitionID(desc.getPartitionId(), executionId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.producedPartitions[counter] = <span class="keyword">new</span> ResultPartition(</span><br><span class="line">            taskNameWithSubtaskAndId,</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            jobId,</span><br><span class="line">            partitionId,</span><br><span class="line">            desc.getPartitionType(),</span><br><span class="line">            desc.getNumberOfSubpartitions(),</span><br><span class="line">            desc.getMaxParallelism(),</span><br><span class="line">            networkEnvironment.getResultPartitionManager(),</span><br><span class="line">            resultPartitionConsumableNotifier,</span><br><span class="line">            ioManager,</span><br><span class="line">            desc.sendScheduleOrUpdateConsumersMessage());</span><br><span class="line"></span><br><span class="line">        ++counter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Consumed intermediate result partitions</span></span><br><span class="line">    <span class="keyword">this</span>.inputGates = <span class="keyword">new</span> SingleInputGate[inputGateDeploymentDescriptors.size()];</span><br><span class="line">    <span class="keyword">this</span>.inputGatesById = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (InputGateDeploymentDescriptor inputGateDeploymentDescriptor: inputGateDeploymentDescriptors) &#123;</span><br><span class="line">        SingleInputGate gate = SingleInputGate.create(</span><br><span class="line">            taskNameWithSubtaskAndId,</span><br><span class="line">            jobId,</span><br><span class="line">            executionId,</span><br><span class="line">            inputGateDeploymentDescriptor,</span><br><span class="line">            networkEnvironment,</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            metricGroup.getIOMetricGroup());</span><br><span class="line"></span><br><span class="line">        inputGates[counter] = gate;</span><br><span class="line">        inputGatesById.put(gate.getConsumedResultId(), gate);</span><br><span class="line"></span><br><span class="line">        ++counter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    invokableHasBeenCanceled = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// finally, create the executing thread, but do not start it</span></span><br><span class="line">    <span class="comment">// 最后，创建一个Thread对象，并把自己放进该对象，这样在执行时，自己就有了自身的线程的引用。</span></span><br><span class="line"></span><br><span class="line">    executingThread = <span class="keyword">new</span> Thread(TASK_THREADS_GROUP, <span class="keyword">this</span>, taskNameWithSubtask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，创建一个Thread对象，并把自己放进该对象，这样在执行时，自己就有了自身的线程 的引用。</p>
<p><br></p>
<h5 id="3-2-2-运行Task对象"><a href="#3-2-2-运行Task对象" class="headerlink" title="3.2.2 运行Task对象"></a>3.2.2 运行Task对象</h5><p>Task对象本身就是一个Runable，因此在其run方法里定义了运行逻辑。 第一步是切换Task的状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The core work method that bootstraps the task and executes its code.</span></span><br><span class="line"><span class="comment">	 * Task对象本身就是一个Runable，因此在其run方法里定义了运行逻辑。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------------------------</span></span><br><span class="line">    <span class="comment">//  Initial State transition</span></span><br><span class="line">    <span class="comment">//  1. 先确定运行状态，也就是切换状态； 整个while 循环都是做这件事的</span></span><br><span class="line">    <span class="comment">// ----------------------------</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        ExecutionState current = <span class="keyword">this</span>.executionState;</span><br><span class="line">        <span class="comment">// 如果当前的执行状态为CREATED，则将其设置为DEPLOYING状态</span></span><br><span class="line">        <span class="keyword">if</span> (current == ExecutionState.CREATED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (transitionState(ExecutionState.CREATED, ExecutionState.DEPLOYING)) &#123;</span><br><span class="line">                <span class="comment">// success, we can start our work</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果当前执行状态为FAILED，则发出通知并退出run方法</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.FAILED) &#123;</span><br><span class="line">            <span class="comment">// we were immediately failed. tell the TaskManager that we reached our final state</span></span><br><span class="line">            notifyFinalState();</span><br><span class="line">            <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                metrics.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果当前执行状态为CANCELING，则将其修改为CANCELED状态，并退出run</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.CANCELING) &#123;</span><br><span class="line">            <span class="keyword">if</span> (transitionState(ExecutionState.CANCELING, ExecutionState.CANCELED)) &#123;</span><br><span class="line">                <span class="comment">// we were immediately canceled. tell the TaskManager that we reached our final state</span></span><br><span class="line">                notifyFinalState();</span><br><span class="line">                <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    metrics.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则说明发生了异常</span></span><br><span class="line">            <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                metrics.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid state for beginning of operation of task "</span> + <span class="keyword">this</span> + <span class="string">'.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从这里开始的所有资源获取和注册,最终都需要撤消</span></span><br><span class="line">    <span class="comment">// all resource acquisitions and registrations from here on</span></span><br><span class="line">    <span class="comment">// need to be undone in the end</span></span><br><span class="line">    Map&lt;String, Future&lt;Path&gt;&gt; distributedCacheEntries = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    AbstractInvokable invokable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ----------------------------</span></span><br><span class="line">        <span class="comment">//  Task Bootstrap - We periodicall check for canceling as a shortcut</span></span><br><span class="line">        <span class="comment">//  2. 启动任务的入口，会定期检查任务状态，主要做了初始化用户类加载器的工作；</span></span><br><span class="line">        <span class="comment">// ----------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// activate safety net for task thread</span></span><br><span class="line">        LOG.info(<span class="string">"Creating FileSystem stream leak safety net for task &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">        FileSystemSafetyNet.initializeSafetyNetForThread();</span><br><span class="line"></span><br><span class="line">        blobService.getPermanentBlobService().registerJob(jobId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// first of all, get a user-code classloader</span></span><br><span class="line">        <span class="comment">// this may involve downloading the job's JAR files and/or classes</span></span><br><span class="line">        LOG.info(<span class="string">"Loading JAR files for task &#123;&#125;."</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 导入用户类加载器并加载用户代码。</span></span><br><span class="line">        userCodeClassLoader = createUserCodeClassloader();</span><br><span class="line">        <span class="keyword">final</span> ExecutionConfig executionConfig = serializedExecutionConfig.deserializeValue(userCodeClassLoader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (executionConfig.getTaskCancellationInterval() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// override task cancellation interval from Flink config if set in ExecutionConfig</span></span><br><span class="line">            taskCancellationInterval = executionConfig.getTaskCancellationInterval();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (executionConfig.getTaskCancellationTimeout() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// override task cancellation timeout from Flink config if set in ExecutionConfig</span></span><br><span class="line">            taskCancellationTimeout = executionConfig.getTaskCancellationTimeout();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isCanceledOrFailed()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">        <span class="comment">// register the task with the network stack this operation may fail if the system does not have enough memory to run the necessary data exchanges the registration must also strictly be undone</span></span><br><span class="line">        <span class="comment">// 3. 使用 NetworkEnvironment 服务注册任务,</span></span><br><span class="line">        <span class="comment">// 		如果系统没有足够的内存来运行必要的数据交换，则此操作可能会失败，</span></span><br><span class="line">        <span class="comment">// 		如果注册失败，也必须严格保证撤消任务，防止资源的浪费</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 主要做的工作是分配一些网络资源，监控指标，读入缓存文件等准备工作</span></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">"Registering task at network: &#123;&#125;."</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//然后，是向网络管理器注册当前任务（flink的各个算子在运行时进行数据交换需要依赖网络管理器），分配一些缓存以保存数据</span></span><br><span class="line">        network.registerTask(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add metrics for buffers</span></span><br><span class="line">        <span class="keyword">this</span>.metrics.getIOMetricGroup().initializeBufferMetrics(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// register detailed network metrics, if configured</span></span><br><span class="line">        <span class="comment">// 注册详细的网络问题指标，如果配置了的话；</span></span><br><span class="line">        <span class="keyword">if</span> (taskManagerConfig.getConfiguration().getBoolean(TaskManagerOptions.NETWORK_DETAILED_METRICS)) &#123;</span><br><span class="line">            <span class="comment">// similar to MetricUtils.instantiateNetworkMetrics() but inside this IOMetricGroup</span></span><br><span class="line">            MetricGroup networkGroup = <span class="keyword">this</span>.metrics.getIOMetricGroup().addGroup(<span class="string">"Network"</span>);</span><br><span class="line">            MetricGroup outputGroup = networkGroup.addGroup(<span class="string">"Output"</span>);</span><br><span class="line">            MetricGroup inputGroup = networkGroup.addGroup(<span class="string">"Input"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// output metrics</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; producedPartitions.length; i++) &#123;</span><br><span class="line">                ResultPartitionMetrics.registerQueueLengthMetrics(</span><br><span class="line">                    outputGroup.addGroup(i), producedPartitions[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputGates.length; i++) &#123;</span><br><span class="line">                InputGateMetrics.registerQueueLengthMetrics(</span><br><span class="line">                    inputGroup.addGroup(i), inputGates[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// next, kick off the background copying of files for the distributed cache</span></span><br><span class="line">        <span class="comment">// 接下来，启动分布式缓存的文件的后台复制，也就是读入指定的缓存文件。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; entry :</span><br><span class="line">                 DistributedCache.readFileInfoFromConfig(jobConfiguration)) &#123;</span><br><span class="line">                LOG.info(<span class="string">"Obtaining local cache file for '&#123;&#125;'."</span>, entry.getKey());</span><br><span class="line">                Future&lt;Path&gt; cp = fileCache.createTmpFile(entry.getKey(), entry.getValue(), jobId, executionId);</span><br><span class="line">                distributedCacheEntries.put(entry.getKey(), cp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">                String.format(<span class="string">"Exception while adding files to distributed cache of task %s (%s)."</span>, taskNameWithSubtask, executionId), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isCanceledOrFailed()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">        <span class="comment">//  call the user code initialization methods</span></span><br><span class="line">        <span class="comment">//  4. 调用用户代码初始化方法</span></span><br><span class="line">        <span class="comment">// 主要的工作是构建一个执行环境，然后初始化用户类的执行方法(也就是初始化invokable，但是并没有真正执行，真正的执行在第五步)</span></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        TaskKvStateRegistry kvStateRegistry = network.createKvStateTaskRegistry(jobId, getJobVertexId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 然后，再把task创建时传入的那一大堆变量用于创建一个执行环境Envrionment。</span></span><br><span class="line">        Environment env = <span class="keyword">new</span> RuntimeEnvironment(</span><br><span class="line">            jobId,</span><br><span class="line">            vertexId,</span><br><span class="line">            executionId,</span><br><span class="line">            executionConfig,</span><br><span class="line">            taskInfo,</span><br><span class="line">            jobConfiguration,</span><br><span class="line">            taskConfiguration,</span><br><span class="line">            userCodeClassLoader,</span><br><span class="line">            memoryManager,</span><br><span class="line">            ioManager,</span><br><span class="line">            broadcastVariableManager,</span><br><span class="line">            taskStateManager,</span><br><span class="line">            accumulatorRegistry,</span><br><span class="line">            kvStateRegistry,</span><br><span class="line">            inputSplitProvider,</span><br><span class="line">            distributedCacheEntries,</span><br><span class="line">            producedPartitions,</span><br><span class="line">            inputGates,</span><br><span class="line">            network.getTaskEventDispatcher(),</span><br><span class="line">            checkpointResponder,</span><br><span class="line">            taskManagerConfig,</span><br><span class="line">            metrics,</span><br><span class="line">            <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// now load and instantiate the task's invokable code</span></span><br><span class="line">        <span class="comment">//通过反射生成对象，这个invokable是在解析JobGraph的时候生成相关信息的，并在此处形成真正可执行的对象</span></span><br><span class="line">        <span class="comment">// invokable 就是几种任务的可执行抽象（可以被taskmanager可以直接执行的），</span></span><br><span class="line">        <span class="comment">// 也就是说flink的tm只能执行几种类型的任务，loadAndInstantiateInvokable就是把用户的opertion转换为对应类型的任务</span></span><br><span class="line">        <span class="comment">// 具体解析可以 查看 StreamTask 的 代码解析</span></span><br><span class="line">        invokable = loadAndInstantiateInvokable(userCodeClassLoader, nameOfInvokableClass, env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">        <span class="comment">//  actual task core work</span></span><br><span class="line">        <span class="comment">// 5. 实际任务的核心工作！！！！</span></span><br><span class="line">        <span class="comment">// 主要的工作就是执行invokable，执行用户的操作；</span></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// we must make strictly sure that the invokable is accessible to the cancel() call</span></span><br><span class="line">        <span class="comment">// by the time we switched to running.</span></span><br><span class="line">        <span class="comment">// 我们必须严格确保在我们切换到任务状态到运行时，cancel（）方法的调用可以访问invokable。否则任务就无法停止了；</span></span><br><span class="line">        <span class="keyword">this</span>.invokable = invokable;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// switch to the RUNNING state, if that fails, we have been canceled/failed in the meantime</span></span><br><span class="line">        <span class="comment">// 切换到RUNNING状态，如果失败，抛出任务被取消的异常；</span></span><br><span class="line">        <span class="keyword">if</span> (!transitionState(ExecutionState.DEPLOYING, ExecutionState.RUNNING)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// notify everyone that we switched to running</span></span><br><span class="line">        <span class="comment">// 通知所有人任务已经切换到running 状态；</span></span><br><span class="line">        notifyObservers(ExecutionState.RUNNING, <span class="keyword">null</span>);</span><br><span class="line">        taskManagerActions.updateTaskExecutionState(<span class="keyword">new</span> TaskExecutionState(jobId, executionId, ExecutionState.RUNNING));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// make sure the user code classloader is accessible thread-locally</span></span><br><span class="line">        <span class="comment">// 确保用户代码类加载器可以线程本地访问</span></span><br><span class="line">        executingThread.setContextClassLoader(userCodeClassLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// run the invokable</span></span><br><span class="line">        <span class="comment">// 最重要的方法；因为这个方法就是用户代码所真正被执行的入口。比如我们写的什么 new MapFunction()的逻辑，</span></span><br><span class="line">        <span class="comment">// 最终就是在这里被执行的。这里说一下这个invokable，这是一个抽象类，提供了可以被TaskManager执行的对象的基本抽象。</span></span><br><span class="line">        invokable.invoke();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// make sure, we enter the catch block if the task leaves the invoke() method due</span></span><br><span class="line">        <span class="comment">// to the fact that it has been canceled</span></span><br><span class="line">        <span class="keyword">if</span> (isCanceledOrFailed()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">        <span class="comment">//  finalization of a successful execution</span></span><br><span class="line">        <span class="comment">//  6. 成功执行任务，</span></span><br><span class="line">        <span class="comment">//  主要的工作就是释放一些资源，然后尝试把任务标记为 finished，标记失败，则取消任务；</span></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// finish the produced partitions. if this fails, we consider the execution failed.</span></span><br><span class="line">        <span class="keyword">for</span> (ResultPartition partition : producedPartitions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (partition != <span class="keyword">null</span>) &#123;</span><br><span class="line">                partition.finish();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try to mark the task as finished</span></span><br><span class="line">        <span class="comment">// if that fails, the task was canceled/failed in the meantime</span></span><br><span class="line">        <span class="comment">// 尝试把该任务标记为finished，如果失败，则调用取消任务，或者标记任务失败；</span></span><br><span class="line">        <span class="keyword">if</span> (transitionState(ExecutionState.RUNNING, ExecutionState.FINISHED)) &#123;</span><br><span class="line">            notifyObservers(ExecutionState.FINISHED, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// unwrap wrapped exceptions to make stack traces more compact</span></span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> WrappingRuntimeException) &#123;</span><br><span class="line">            t = ((WrappingRuntimeException) t).unwrap();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">        <span class="comment">// the execution failed. either the invokable code properly failed, or</span></span><br><span class="line">        <span class="comment">// an exception was thrown as a side effect of cancelling</span></span><br><span class="line">        <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// check if the exception is unrecoverable</span></span><br><span class="line">            <span class="keyword">if</span> (ExceptionUtils.isJvmFatalError(t) ||</span><br><span class="line">                (t <span class="keyword">instanceof</span> OutOfMemoryError &amp;&amp; taskManagerConfig.shouldExitJvmOnOutOfMemoryError())) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// terminate the JVM immediately</span></span><br><span class="line">                <span class="comment">// don't attempt a clean shutdown, because we cannot expect the clean shutdown to complete</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOG.error(<span class="string">"Encountered fatal error &#123;&#125; - terminating the JVM"</span>, t.getClass().getName(), t);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().halt(-<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// transition into our final state. we should be either in DEPLOYING, RUNNING, CANCELING, or FAILED</span></span><br><span class="line">            <span class="comment">// loop for multiple retries during concurrent state changes via calls to cancel() or</span></span><br><span class="line">            <span class="comment">// to failExternally()</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                ExecutionState current = <span class="keyword">this</span>.executionState;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (current == ExecutionState.RUNNING || current == ExecutionState.DEPLOYING) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t <span class="keyword">instanceof</span> CancelTaskException) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (transitionState(current, ExecutionState.CANCELED)) &#123;</span><br><span class="line">                            cancelInvokable(invokable);</span><br><span class="line"></span><br><span class="line">                            notifyObservers(ExecutionState.CANCELED, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (transitionState(current, ExecutionState.FAILED, t)) &#123;</span><br><span class="line">                            <span class="comment">// proper failure of the task. record the exception as the root cause</span></span><br><span class="line">                            String errorMessage = String.format(<span class="string">"Execution of %s (%s) failed."</span>, taskNameWithSubtask, executionId);</span><br><span class="line">                            failureCause = t;</span><br><span class="line">                            cancelInvokable(invokable);</span><br><span class="line"></span><br><span class="line">                            notifyObservers(ExecutionState.FAILED, <span class="keyword">new</span> Exception(errorMessage, t));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.CANCELING) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (transitionState(current, ExecutionState.CANCELED)) &#123;</span><br><span class="line">                        notifyObservers(ExecutionState.CANCELED, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.FAILED) &#123;</span><br><span class="line">                    <span class="comment">// in state failed already, no transition necessary any more</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// unexpected state, go to failed</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (transitionState(current, ExecutionState.FAILED, t)) &#123;</span><br><span class="line">                    LOG.error(<span class="string">"Unexpected state in task &#123;&#125; (&#123;&#125;) during an exception: &#123;&#125;."</span>, taskNameWithSubtask, executionId, current);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// else fall through the loop and</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable tt) &#123;</span><br><span class="line">            String message = String.format(<span class="string">"FATAL - exception in exception handler of task %s (%s)."</span>, taskNameWithSubtask, executionId);</span><br><span class="line">            LOG.error(message, tt);</span><br><span class="line">            notifyFatalError(message, tt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOG.info(<span class="string">"Freeing task resources for &#123;&#125; (&#123;&#125;)."</span>, taskNameWithSubtask, executionId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// clear the reference to the invokable. this helps guard against holding references</span></span><br><span class="line">            <span class="comment">// to the invokable and its structures in cases where this Task object is still referenced</span></span><br><span class="line">            <span class="keyword">this</span>.invokable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// stop the async dispatcher.</span></span><br><span class="line">            <span class="comment">// copy dispatcher reference to stack, against concurrent release</span></span><br><span class="line">            ExecutorService dispatcher = <span class="keyword">this</span>.asyncCallDispatcher;</span><br><span class="line">            <span class="keyword">if</span> (dispatcher != <span class="keyword">null</span> &amp;&amp; !dispatcher.isShutdown()) &#123;</span><br><span class="line">                dispatcher.shutdownNow();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// free the network resources</span></span><br><span class="line">            network.unregisterTask(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// free memory resources</span></span><br><span class="line">            <span class="keyword">if</span> (invokable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                memoryManager.releaseAll(invokable);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// remove all of the tasks library resources</span></span><br><span class="line">            libraryCache.unregisterTask(jobId, executionId);</span><br><span class="line">            fileCache.releaseJob(jobId, executionId);</span><br><span class="line">            blobService.getPermanentBlobService().releaseJob(jobId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// close and de-activate safety net for task thread</span></span><br><span class="line">            LOG.info(<span class="string">"Ensuring all FileSystem streams are closed for task &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">            FileSystemSafetyNet.closeSafetyNetAndGuardedResourcesForThread();</span><br><span class="line"></span><br><span class="line">            notifyFinalState();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="comment">// an error in the resource cleanup is fatal</span></span><br><span class="line">            String message = String.format(<span class="string">"FATAL - exception in resource cleanup of task %s (%s)."</span>, taskNameWithSubtask, executionId);</span><br><span class="line">            LOG.error(message, t);</span><br><span class="line">            notifyFatalError(message, t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// un-register the metrics at the end so that the task may already be</span></span><br><span class="line">        <span class="comment">// counted as finished when this happens</span></span><br><span class="line">        <span class="comment">// errors here will only be logged</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            metrics.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            LOG.error(<span class="string">"Error during metrics de-registration of task &#123;&#125; (&#123;&#125;)."</span>, taskNameWithSubtask, executionId, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>其实这里有个值得关注的点，就是flink里大量使用了这种while(true)的写法来修改和检测状 态，emmm…</p>
<p>接下来，就是导入用户类加载器并加载用户代码。</p>
<p>然后，是向网络管理器注册当前任务（flink的各个算子在运行时进行数据交换需要依赖网络管 理器），分配一些缓存以保存数据</p>
<p>然后，读入指定的缓存文件。</p>
<p>然后，再把task创建时传入的那一大堆变量用于创建一个执行环境Envrionment。</p>
<p>再然后，对于那些并不是第一次执行的task（比如失败后重启的）要恢复其状态。</p>
<p>接下来最重要的是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invokable.invoke();</span><br></pre></td></tr></table></figure>
<p>方法。为什么这么说呢，因为这个方法就是用户代码所真正被执行的入口。比如我们写的什么 new MapFunction()的逻辑，最终就是在这里被执行的。这里说一下这个invokable，这是一个抽象类，提供了可以被TaskManager执行的对象的基本抽象。</p>
<p>这个invokable是在解析JobGraph的时候生成相关信息的，并在此处形成真正可执行的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Task.Java</span></span><br><span class="line"><span class="comment">// now load and instantiate the task's invokable code</span></span><br><span class="line"><span class="comment">//通过反射生成对象，这个invokable是在解析JobGraph的时候生成相关信息的，并在此处形成真正可执行的对象</span></span><br><span class="line"><span class="comment">// invokable 就是几种任务的可执行抽象（可以被taskmanager可以直接执行的），</span></span><br><span class="line"><span class="comment">// 也就是说flink的tm只能执行几种类型的任务，loadAndInstantiateInvokable就是把用户的opertion转换为对应类型的任务</span></span><br><span class="line"><span class="comment">// 具体解析可以 查看 StreamTask 的 代码解析</span></span><br><span class="line">invokable = loadAndInstantiateInvokable(userCodeClassLoader, nameOfInvokableClass, env);</span><br></pre></td></tr></table></figure>
<p><br></p>
<img src="/clay4444.github.io/posts/149d881d/七.jpg">
<p>上图显示了flink提供的可被执行的Task类型。从名字上就可以看出各个task的作用，在此不再 赘述。</p>
<p>接下来就是invoke方法了，因为我们的wordcount例子用了流式api，在此我们以StreamTask 的invoke方法为例进行说明。</p>
<p><br></p>
<h5 id="3-2-3-StreamTask的执行逻辑"><a href="#3-2-3-StreamTask的执行逻辑" class="headerlink" title="3.2.3 StreamTask的执行逻辑"></a>3.2.3 StreamTask的执行逻辑</h5><p>先上部分核心代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * tm执行task时调用的 invokable 方法就是这个方法；</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> disposed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// -------- Initialize ---------</span></span><br><span class="line">        <span class="comment">//	先做一些赋值操作</span></span><br><span class="line">        LOG.debug(<span class="string">"Initializing &#123;&#125;."</span>, getName());</span><br><span class="line"></span><br><span class="line">        asyncOperationsThreadPool = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        CheckpointExceptionHandlerFactory cpExceptionHandlerFactory = createCheckpointExceptionHandlerFactory();</span><br><span class="line"></span><br><span class="line">        synchronousCheckpointExceptionHandler = cpExceptionHandlerFactory.createCheckpointExceptionHandler(</span><br><span class="line">            getExecutionConfig().isFailTaskOnCheckpointError(),</span><br><span class="line">            getEnvironment());</span><br><span class="line"></span><br><span class="line">        asynchronousCheckpointExceptionHandler = <span class="keyword">new</span> AsyncCheckpointExceptionHandler(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        stateBackend = createStateBackend();</span><br><span class="line">        checkpointStorage = stateBackend.createCheckpointStorage(getEnvironment().getJobID());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the clock is not already set, then assign a default TimeServiceProvider</span></span><br><span class="line">        <span class="comment">// 处理timer</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * timerService 是一个计时器服务</span></span><br><span class="line"><span class="comment">			 * 将计时器作为StreamTask中的服务集成，StreamOperators可以通过调用StreamingRuntimeContext上的方法来使用它。</span></span><br><span class="line"><span class="comment">			 * 这也确保了不能与StreamOperator上的其他方法同时调用计时器回调。 ITCase确保了这种行为。</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">        <span class="keyword">if</span> (timerService == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ThreadFactory timerThreadFactory = <span class="keyword">new</span> DispatcherThreadFactory(TRIGGER_THREAD_GROUP,</span><br><span class="line">                                                                           <span class="string">"Time Trigger for "</span> + getName(), getUserCodeClassLoader());</span><br><span class="line"></span><br><span class="line">            timerService = <span class="keyword">new</span> SystemProcessingTimeService(<span class="keyword">this</span>, getCheckpointLock(), timerThreadFactory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把之前JobGraph串起来的chain的信息形成实现，chain 操作</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * 第二个要注意的是chain操作。前面提到了，flink会出于优化的角度，把一些算子chain成一个 整体的算子作为一个task来执行。</span></span><br><span class="line"><span class="comment">			 * 比如wordcount例子中，Source和FlatMap算子就被chain在了一起。在进行chain操作的时候，会设定头节点，并且指定输出的RecordWriter。</span></span><br><span class="line"><span class="comment">			 * 具体的原理</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">        operatorChain = <span class="keyword">new</span> OperatorChain&lt;&gt;(<span class="keyword">this</span>, streamRecordWriters);</span><br><span class="line">        headOperator = operatorChain.getHeadOperator();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// task specific initialization</span></span><br><span class="line">        <span class="comment">//这个init操作的起名非常诡异，</span></span><br><span class="line">        <span class="comment">//因为这里主要是处理算子采用了自定义的checkpoint检查机制的情况，但是起了一个非常大众脸的名字</span></span><br><span class="line">        init();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// save the work of reloading state, etc, if the task is already canceled</span></span><br><span class="line">        <span class="keyword">if</span> (canceled) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -------- Invoke --------</span></span><br><span class="line">        LOG.debug(<span class="string">"Invoking &#123;&#125;"</span>, getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we need to make sure that any triggers scheduled in open() cannot be</span></span><br><span class="line">        <span class="comment">// executed before all operators are opened</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// both the following operations are protected by the lock</span></span><br><span class="line">            <span class="comment">// so that we avoid race conditions in the case that initializeState()</span></span><br><span class="line">            <span class="comment">// registers a timer, that fires before the open() is called.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化操作符状态，主要是一些state啥的</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">				 * 初始化每个算子的状态，初始化的对象变成了各个operator。如果是有 checkpoint的，那就从state信息里恢复，不然就作为全新的算子处理。</span></span><br><span class="line"><span class="comment">				 * 从源码中可以看到，flink针对keyed算子和普通算子做了不同的处理。keyed算子在初始化时需要计算出一个 group区间，</span></span><br><span class="line"><span class="comment">				 * 这个区间的值在整个生命周期里都不会再变化，后面key就会根据hash的不同结果，分配到特定的group中去计算。</span></span><br><span class="line"><span class="comment">				 * 顺便提一句，flink的keyed算子保存的是对每个数据的key的计算方法，而非真实的key，用户需要自己保证对每一行数据提供的keySelector的幂等性。</span></span><br><span class="line"><span class="comment">				 * 至于为什么要用KeyGroup的设计，这就牵扯到扩容的范畴了，将在后面的章节进行讲述。</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">            initializeState();</span><br><span class="line">            <span class="comment">//对于富操作符，执行其open操作</span></span><br><span class="line">            <span class="comment">// 就是对各种RichOperator执行其open方法，通常可用于在执行计算之前加载资源。</span></span><br><span class="line">            openAllOperators();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// final check to exit early before starting to run</span></span><br><span class="line">        <span class="keyword">if</span> (canceled) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// let the task do its work</span></span><br><span class="line">        <span class="comment">//真正开始执行的代码</span></span><br><span class="line">        isRunning = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * 最终调用到run方法，该方法经过一系列跳转，最终调用chain上的第一个算子的run方法。</span></span><br><span class="line"><span class="comment">			 * 在wordcount的例子中，它最终调用了SocketTextStreamFunction的run，建立socket连接并读入文本。</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">        run();</span><br></pre></td></tr></table></figure>
<p>StreamTask.invoke()方法里，第一个值得一说的是 TimerService 。Flink在2015年决定向 StreamTask类加入timer service的时候解释到：</p>
<p>This integrates the timer as a service in StreamTask that StreamOperators can use by calling a method on the StreamingRuntimeContext. This also ensures that the timer callbacks can not be called concurrently with other methods on the StreamOperator. This behaviour is ensured by an ITCase.</p>
<p>第二个要注意的是chain操作。前面提到了，flink会出于优化的角度，把一些算子chain成一个 整体的算子作为一个task来执行。比如wordcount例子中，Source和FlatMap算子就被chain 在了一起。在进行chain操作的时候，会设定头节点，并且指定输出的RecordWriter。</p>
<p>接下来不出所料仍然是初始化，只不过初始化的对象变成了各个operator。如果是有 checkpoint的，那就从state信息里恢复，不然就作为全新的算子处理。从源码中可以看 到，flink针对keyed算子和普通算子做了不同的处理。keyed算子在初始化时需要计算出一个 group区间，这个区间的值在整个生命周期里都不会再变化，后面key就会根据hash的不同结 果，分配到特定的group中去计算。顺便提一句，flink的keyed算子保存的是对每个数据的 key的计算方法，而非真实的key，用户需要自己保证对每一行数据提供的keySelector的幂等 性。至于为什么要用KeyGroup的设计，这就牵扯到扩容的范畴了，将在后面的章节进行讲 述。</p>
<p>对于 openAllOperators() 方法，就是对各种RichOperator执行其open方法，通常可用于在 执行计算之前加载资源。 最后，run方法千呼万唤始出来，该方法经过一系列跳转，最终调用chain上的第一个算子的 run方法。在wordcount的例子中，它最终调用了SocketTextStreamFunction的run，建立 socket连接并读入文本。</p>
<p><br></p>
<h4 id="3-3-StreamTask与StreamOperator"><a href="#3-3-StreamTask与StreamOperator" class="headerlink" title="3.3 StreamTask与StreamOperator"></a>3.3 StreamTask与StreamOperator</h4><p>前面提到，Task对象在执行过程中，把执行的任务交给了StreamTask这个类去执行。在我们 的wordcount例子中，实际初始化的是OneInputStreamTask的对象（参考上面的类图）。那 么这个对象是如何执行用户的代码的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Task对象在执行过程中，把执行的任务交给了StreamTask这个类去执行。在我们的 wordcount 例子中，</span></span><br><span class="line"><span class="comment">	 * 实际初始化的是OneInputStreamTask的对象（参考OneInputStreamTask的类继承图）。那么这个对象是如何执行用户的代码的呢？</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * 这就是 run 方法所做的事；</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * 它做的，就是把任务直接交给了InputProcessor去执行processInput方法。这是一个 StreamInputProcessor 的实例，</span></span><br><span class="line"><span class="comment">	 * 该processor的任务就是处理输入的数据，包括用户数据、watermark和checkpoint数据等</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// cache processor reference on the stack, to make the code more JIT friendly</span></span><br><span class="line">    <span class="keyword">final</span> StreamInputProcessor&lt;IN&gt; inputProcessor = <span class="keyword">this</span>.inputProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//processInput，处理输入数据</span></span><br><span class="line">    <span class="keyword">while</span> (running &amp;&amp; inputProcessor.processInput()) &#123;</span><br><span class="line">        <span class="comment">// all the work happens in the "processInput" method</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它做的，就是把任务直接交给了InputProcessor去执行processInput方法。这是一 个 StreamInputProcessor 的实例，该processor的任务就是处理输入的数据，包括用户数 据、watermark和checkpoint数据等。我们先来看看这个processor是如何产生的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 初始化 inputProcessor：inputProcessor就是处理用户数据，watermark，checkpoint的数据的;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    StreamConfig configuration = getConfiguration();</span><br><span class="line"></span><br><span class="line">    TypeSerializer&lt;IN&gt; inSerializer = configuration.getTypeSerializerIn1(getUserCodeClassLoader());</span><br><span class="line">    <span class="keyword">int</span> numberOfInputs = configuration.getNumberOfInputs();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numberOfInputs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        InputGate[] inputGates = getEnvironment().getAllInputGates();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成 inputProcessor</span></span><br><span class="line">        inputProcessor = <span class="keyword">new</span> StreamInputProcessor&lt;&gt;(</span><br><span class="line">            inputGates,</span><br><span class="line">            inSerializer,</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            configuration.getCheckpointMode(),</span><br><span class="line">            getCheckpointLock(),</span><br><span class="line">            getEnvironment().getIOManager(),</span><br><span class="line">            getEnvironment().getTaskManagerInfo().getConfiguration(),</span><br><span class="line">            getStreamStatusMaintainer(),</span><br><span class="line">            <span class="keyword">this</span>.headOperator,</span><br><span class="line">            getEnvironment().getMetricGroup().getIOMetricGroup(),</span><br><span class="line">            inputWatermarkGauge);</span><br><span class="line">    &#125;</span><br><span class="line">    headOperator.getMetricGroup().gauge(MetricNames.IO_CURRENT_INPUT_WATERMARK, <span class="keyword">this</span>.inputWatermarkGauge);</span><br><span class="line">    <span class="comment">// wrap watermark gauge since registered metrics must be unique</span></span><br><span class="line">    getEnvironment().getMetricGroup().gauge(MetricNames.IO_CURRENT_INPUT_WATERMARK, <span class="keyword">this</span>.inputWatermarkGauge::getValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是OneInputStreamTask的init方法，从configs里面获取StreamOperator信息，生成自己 的inputProcessor。那么inputProcessor是如何处理数据的呢？我们接着跟进源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 处理输入的数据，包括用户数据、watermark 和 checkpoint数据等</span></span><br><span class="line"><span class="comment">	 * 到这里整个flink数据流转的过程就结束了，简单总结一下：</span></span><br><span class="line"><span class="comment">	 * 1.启动一个环境</span></span><br><span class="line"><span class="comment">	 * 2.生成StreamGraph</span></span><br><span class="line"><span class="comment">	 * 3.注册和选举JobManager</span></span><br><span class="line"><span class="comment">	 * 4.在各节点生成TaskManager，并根据JobGraph生成对应的Task</span></span><br><span class="line"><span class="comment">	 * 5.启动各个task，准备执行代码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processInput</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isFinished) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (numRecordsIn == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            numRecordsIn = ((OperatorMetricGroup) streamOperator.getMetricGroup()).getIOMetricGroup().getNumRecordsInCounter();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"An exception occurred during the metrics setup."</span>, e);</span><br><span class="line">            numRecordsIn = <span class="keyword">new</span> SimpleCounter();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个while是用来处理单个元素的（不要想当然以为是循环处理元素的）</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">//注意 1在下面</span></span><br><span class="line">        <span class="comment">// 2.接下来，会利用这个反序列化器得到下一个数据记录，并进行解析（是用户数据还是watermark等等），然后进行对应的操作</span></span><br><span class="line">        <span class="keyword">if</span> (currentRecordDeserializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            DeserializationResult result = currentRecordDeserializer.getNextRecord(deserializationDelegate);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result.isBufferConsumed()) &#123;</span><br><span class="line">                currentRecordDeserializer.getCurrentBuffer().recycleBuffer();</span><br><span class="line">                currentRecordDeserializer = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result.isFullRecord()) &#123;</span><br><span class="line">                StreamElement recordOrMark = deserializationDelegate.getInstance();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//如果元素是watermark，就准备更新当前channel的watermark 值（并不是简单赋值，因为有乱序存在），</span></span><br><span class="line">                <span class="keyword">if</span> (recordOrMark.isWatermark()) &#123;</span><br><span class="line">                    <span class="comment">// handle watermark</span></span><br><span class="line">                    statusWatermarkValve.inputWatermark(recordOrMark.asWatermark(), currentChannel);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//如果元素是status，就进行相应处理。可以看作是一个flag，标志着当前stream接下来即将没有元素输入（idle），</span></span><br><span class="line">                    <span class="comment">// 或者当前即将由空闲状态转为有元素状态 （active）。同时，StreamStatus 还对如何处理watermark有影响。</span></span><br><span class="line">                    <span class="comment">// 通过发送status，上游的operator可以很方便的通知下游当前的数据流的状态。</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recordOrMark.isStreamStatus()) &#123;</span><br><span class="line">                    <span class="comment">// handle stream status</span></span><br><span class="line">                    statusWatermarkValve.inputStreamStatus(recordOrMark.asStreamStatus(), currentChannel);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//LatencyMarker是用来衡量代码执行时间的。在Source处创建，携带创建时的时间戳，流到Sink时就可以知道经过了多长时间</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recordOrMark.isLatencyMarker()) &#123;</span><br><span class="line">                    <span class="comment">// handle latency marker</span></span><br><span class="line">                    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                        streamOperator.processLatencyMarker(recordOrMark.asLatencyMarker());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">//这里就是真正的，用户的代码即将被执行的地方。从章节1到这里足足用了三万字，有点万里长征的感觉</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// now we can do the actual processing</span></span><br><span class="line">                    StreamRecord&lt;IN&gt; record = recordOrMark.asRecord();</span><br><span class="line">                    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                        numRecordsIn.inc();</span><br><span class="line">                        streamOperator.setKeyContextElement1(record);</span><br><span class="line">                        streamOperator.processElement(record);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.程序首先获取下一个buffer</span></span><br><span class="line">        <span class="comment">//这一段代码是服务于flink的FaultTorrent机制的，后面我会讲到，这里只需理解到它会尝试获取buffer，然后赋值给当前的反序列化器</span></span><br><span class="line">        <span class="comment">//每个元素都会触发这一段逻辑，如果下一个数据是buffer，则从外围的while循环里进入处理用户数据的逻辑；这个方法里默默的处理了barrier的逻辑</span></span><br><span class="line">        <span class="comment">// 处理barrier的过程在这段代码里没有体现，因为被包含在了 getNextNonBlocked() 方法中， 我们看下这个方法的核心逻辑：</span></span><br><span class="line">        <span class="keyword">final</span> BufferOrEvent bufferOrEvent = barrierHandler.getNextNonBlocked();</span><br><span class="line">        <span class="keyword">if</span> (bufferOrEvent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bufferOrEvent.isBuffer()) &#123;</span><br><span class="line">                currentChannel = bufferOrEvent.getChannelIndex();</span><br><span class="line">                currentRecordDeserializer = recordDeserializers[currentChannel];</span><br><span class="line">                currentRecordDeserializer.setNextBuffer(bufferOrEvent.getBuffer());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Event received</span></span><br><span class="line">                <span class="keyword">final</span> AbstractEvent event = bufferOrEvent.getEvent();</span><br><span class="line">                <span class="keyword">if</span> (event.getClass() != EndOfPartitionEvent.class) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected event: "</span> + event);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            isFinished = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!barrierHandler.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Trailing data in checkpoint barrier handler."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>到此为止，以上部分就是一个flink程序启动后，到执行用户代码之前，flink框架所做的准备工 作。回顾一下：</p>
<ul>
<li>启动一个环境</li>
<li>生成StreamGraph</li>
<li>注册和选举JobManager</li>
<li>在各节点生成TaskManager，并根据JobGraph生成对应的Task</li>
<li>启动各个task，准备执行代码</li>
</ul>
<p>接下来，我们挑几个Operator看看flink是如何抽象这些算子的。</p>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="http://clay4444.github.io">clay</a>
            </p><p>原文链接：<a href="http://clay4444.github.io/posts/149d881d/">http://clay4444.github.io/posts/149d881d/</a>
            </p><p>发表日期：<a href="http://clay4444.github.io/posts/149d881d/">June 6th 2019, 11:18:15 am</a>
            </p><p>更新日期：<a href="http://clay4444.github.io/posts/149d881d/">June 7th 2019, 6:32:58 pm</a>
            </p><p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/clay4444.github.io/posts/118b9a37/" title="Flink源码解析之StreamOperator">
                    <div class="nextTitle">Flink源码解析之StreamOperator</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/clay4444.github.io/posts/fade0564/" title="Flink源码解析之三层图结构">
                    <div class="prevTitle">Flink源码解析之三层图结构</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:clay4444@126.com" class="iconfont-archer email" title="email"></a>
            
        
    
        
            
                <a href="//github.com/clay4444" class="iconfont-archer github" target="_blank" title="github"></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title="wechat">
                  
                  <img class="profile-qr" src="/clay4444.github.io/assets/example_qr.png">
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#任务的调度与执行"><span class="toc-number">1.</span> <span class="toc-text">任务的调度与执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-计算资源的调度"><span class="toc-number">1.1.</span> <span class="toc-text">1.计算资源的调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-JobManager执行job"><span class="toc-number">1.2.</span> <span class="toc-text">2.JobManager执行job</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-JobManager的组件"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 JobManager的组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-JobManager的启动过程"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 JobManager的启动过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-JobManager启动Task"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 JobManager启动Task</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-TaskManager执行task"><span class="toc-number">1.3.</span> <span class="toc-text">3. TaskManager执行task</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-TaskManager的基本组件"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 TaskManager的基本组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-TaskManager执行Task"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 TaskManager执行Task</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-生成Task对象"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">3.2.1 生成Task对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-运行Task对象"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">3.2.2 运行Task对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-3-StreamTask的执行逻辑"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3.2.3 StreamTask的执行逻辑</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-StreamTask与StreamOperator"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 StreamTask与StreamOperator</span></a></li></ol></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 172
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/11</span><a class="archive-post-title" href="/clay4444.github.io/posts/da036dae/">Spring注解驱动开发之扩展和源码总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/7b38f501/">Spring注解驱动开发之AOP-声明式事务</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/f1cf47b3/">Spring注解驱动开发之生命周期-属性赋值-自动装配</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/37b5aa5b/">分布式存储系统基础</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/82553e97/">Flink源码解析之数据流转</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/90722dc0/">Flink源码解析之FaultTolerant</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/118b9a37/">Flink源码解析之StreamOperator</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/149d881d/">Flink源码解析之任务的调度与执行</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/05</span><a class="archive-post-title" href="/clay4444.github.io/posts/fade0564/">Flink源码解析之三层图结构</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/05</span><a class="archive-post-title" href="/clay4444.github.io/posts/c75f56/">Flink源码解析之Job提交流程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/19</span><a class="archive-post-title" href="/clay4444.github.io/posts/3308668f/">kafka权威指南第七八章</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/18</span><a class="archive-post-title" href="/clay4444.github.io/posts/f63f9c6e/">kafka权威指南第五六章</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/17</span><a class="archive-post-title" href="/clay4444.github.io/posts/2ce93f5b/">kafka权威指南第二三四章</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/05</span><a class="archive-post-title" href="/clay4444.github.io/posts/5bedbc4e/">深入理解java虚拟机</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span><a class="archive-post-title" href="/clay4444.github.io/posts/f849401d/">算法进阶第一课-3</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/04</span><a class="archive-post-title" href="/clay4444.github.io/posts/ff78c689/">算法进阶第六课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/7f010ad5/">算法基础第六课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/8366812d/">算法进阶第四五课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/22</span><a class="archive-post-title" href="/clay4444.github.io/posts/42c55172/">算法进阶第三课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/fdbf220/">算法进阶第二课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/10</span><a class="archive-post-title" href="/clay4444.github.io/posts/3fcd1ef8/">算法进阶第一课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span><a class="archive-post-title" href="/clay4444.github.io/posts/8bd8430e/">算法基础特别节目</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/26</span><a class="archive-post-title" href="/clay4444.github.io/posts/5a6a5509/">算法基础第八课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/ad017d4a/">算法基础第七课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/1a0f410c/">算法基础第五课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/7591844b/">算法基础第四课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/c2bc9d2e/">算法基础第三课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/22</span><a class="archive-post-title" href="/clay4444.github.io/posts/5c06dc97/">Flink中startNewChain和SlotSharingGroup的区别</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/20</span><a class="archive-post-title" href="/clay4444.github.io/posts/8fa23e7c/">算法基础第二课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/17</span><a class="archive-post-title" href="/clay4444.github.io/posts/bfb4d2a4/">算法基础第一课</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span><a class="archive-post-title" href="/clay4444.github.io/posts/6e3b6e5d/">kafka权威指南第一章</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span><a class="archive-post-title" href="/clay4444.github.io/posts/98dde65a/">StreamingSystem第三章总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/11</span><a class="archive-post-title" href="/clay4444.github.io/posts/613fbfdf/">StreamingSystem一二章总结</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/6f100083/">TwoPhaseCommitSinkFunction</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/03</span><a class="archive-post-title" href="/clay4444.github.io/posts/b8ce2b2d/">sql语句中where与having的区别</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/5bb24833/">ElasticSearch入门（三）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/16aceb61/">ElasticSearch入门（二）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/26ba07b9/">ElasticSearch入门（一）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/dfa909ab/">Flink的Metrics与监控</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/6a73b0f6/">Flink状态管理与恢复机制</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/827d698b/">Flink的Window与Time</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/589f5c61/">DataStreamAPI</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/05</span><a class="archive-post-title" href="/clay4444.github.io/posts/4042ab31/">Flink基本概念与部署</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/04</span><a class="archive-post-title" href="/clay4444.github.io/posts/22d66bb6/">Hive常见优化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span><a class="archive-post-title" href="/clay4444.github.io/posts/ce3cc54d/">zookeeper为什么一定要配置成奇数台</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/8bea7439/">MySql锁机制及索引</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/767c3cbc/">TCP三次握手-四次挥手面试总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/6d00129c/">自旋锁</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/1922d0f6/">常见海量处理题目解题关键</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span><a class="archive-post-title" href="/clay4444.github.io/posts/db7f9c/">深入理解spark之架构与原理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/25</span><a class="archive-post-title" href="/clay4444.github.io/posts/b1a1506f/">查找两个数组的相同字符（两个超大文件的相同字符）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/57f823bb/">MR之参数优化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/4ad64663/">MapReduce框架结构及核心运行机制</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/44c10193/">MapReduce的Task并行度决定机制</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/9799c850/">MR中的计数器、job串联等功能实现</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/403d9f31/">MR之自定义outputFormat</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/68d67dd4/">Mapreduce中的DistributedCache应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/03</span><a class="archive-post-title" href="/clay4444.github.io/posts/9c6cea3b/">Spring注解驱动开发之组件注册</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/44e5bf34/">Git中fork和clone的区别，fetch与pull的区别</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/27</span><a class="archive-post-title" href="/clay4444.github.io/posts/9b145405/">Log4J与slf4j使用详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/eeeb2ca/">Java中的几种引用类型：强引用、软引用、弱引用和虚引用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/b391d3f0/">scala函数式编程和集合进阶</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/ccad62d6/">scala的面向对象和操作符</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/90c61e02/">scala数据类型等基本操作</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/11</span><a class="archive-post-title" href="/clay4444.github.io/posts/c640a1d5/">Java9之模块化和REPL工具</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/09</span><a class="archive-post-title" href="/clay4444.github.io/posts/41355ae3/">Spark作业提交执行流程及底层实现介绍</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/09</span><a class="archive-post-title" href="/clay4444.github.io/posts/3fb5d1b7/">SparkRDD弹性分布式数据集简介及RDD变换</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/09</span><a class="archive-post-title" href="/clay4444.github.io/posts/1761f4b4/">Spark数据倾斜问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/09</span><a class="archive-post-title" href="/clay4444.github.io/posts/77c338dd/">IDEA编译scala文件时不会把scala文件打包的解决办法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/09</span><a class="archive-post-title" href="/clay4444.github.io/posts/b5801fa4/">Spark简介及wc实现</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/d5a66bc5/">Storm和kafka、Hbase之间的整合</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/97e35c7b/">Storm的分组策略和确保消息送达机制</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/9799a940/">Storm架构及其资源分配问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/67e1a306/">Hbase和Hive的集成</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/e1de3e9b/">详解Hbase的rowKey设计（热点问题）和Hbase中的布隆过滤器</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/f7fb5894/">详解Hbase的协处理器coprocessor</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/e73169bb/">详解hbase扫描、过滤、缓存等问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/615ff67f/">详解hbase架构、数据读取、存储、拆分风暴等问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/cedf1ac1/">kafka消息队列初探</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/117ed1fe/">Flume日志收集框架初探</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/edc108ac/">扫盲DNS原理，兼谈域名劫持和域名欺骗+域名污染</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/9194e3d6/">扫盲HTTPS和SSL、TLS协议[1]：背景知识、协议的需求、设计的难点</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/649d866d/">扫盲HTTPS和SSL、TLS协议[2]：可靠密钥交换的难点，以及身份认证的必要性</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/305a7ab3/">数字证书及CA的扫盲介绍</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/fdf5e3ed/">死锁及其解决办法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/969c35d/">并发编程实战(八)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span><a class="archive-post-title" href="/clay4444.github.io/posts/c03b7c51/">并发编程实战(七)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/27</span><a class="archive-post-title" href="/clay4444.github.io/posts/5f3364db/">并发编程实战(六)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/27</span><a class="archive-post-title" href="/clay4444.github.io/posts/c63c2ca9/">并发编程实战(五)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/26</span><a class="archive-post-title" href="/clay4444.github.io/posts/4a0a5133/">Java中的Runnable、Callable、Future、FutureTask的区别与示例</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span><a class="archive-post-title" href="/clay4444.github.io/posts/c2c02cf/">关于HttpSession的线程安全问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span><a class="archive-post-title" href="/clay4444.github.io/posts/92f9baae/">关于JdbcConnection的线程安全问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/3ad494db/">并发编程实战(三)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/c0977bd4/">并发编程实战(四)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/eb162f92/">并发编程实战(一)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/4427b4f0/">并发编程实战(二)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/af70e59d/">MR之自定义GroupingComparator</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/987ce803/">MR之自定义inputFormat</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/a2cd52e0/">MR之社交粉丝数据查找共同好友</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/cc1873ed/">MR之流量统计相关需求</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/29</span><a class="archive-post-title" href="/clay4444.github.io/posts/f932ba85/">数据结构之图</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/27</span><a class="archive-post-title" href="/clay4444.github.io/posts/afe7cf7/">栈的经典应用之中缀表达式和后缀表达式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/26</span><a class="archive-post-title" href="/clay4444.github.io/posts/39aa6912/">数据结构之二叉树</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/409910e4/">数据结构之散列表</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/21</span><a class="archive-post-title" href="/clay4444.github.io/posts/6c17d6bd/">数据结构之树</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/19</span><a class="archive-post-title" href="/clay4444.github.io/posts/786266a6/">Java之Iterator与Iterable的区别</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/17</span><a class="archive-post-title" href="/clay4444.github.io/posts/1c652596/">JDK1.7-Stack源码分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/21482a37/">LinkedHashMap源码赏析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/14</span><a class="archive-post-title" href="/clay4444.github.io/posts/526318cc/">HashMap源码赏析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/13</span><a class="archive-post-title" href="/clay4444.github.io/posts/df7893e2/">LinkedList源码赏析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/d36c0402/">ArrayList删除特定元素的方法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/11</span><a class="archive-post-title" href="/clay4444.github.io/posts/55c3a3c7/">ArrayList添加一个元素add方法的核心</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/5b758090/">ArrayList源码赏析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/6d17d8e0/">Java8系列之新时间和日期API</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/03</span><a class="archive-post-title" href="/clay4444.github.io/posts/91ca9518/">Java8系列之Optional容器</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2017 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/28</span><a class="archive-post-title" href="/clay4444.github.io/posts/9b8b8703/">Java8系列之Stream-API</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/ccf34b81/">Java8系列之Lambda表达式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/21</span><a class="archive-post-title" href="/clay4444.github.io/posts/f26db82e/">Comparator和Comparable详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/20</span><a class="archive-post-title" href="/clay4444.github.io/posts/c4dacfdd/">Java8系列之宏观简介</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/17</span><a class="archive-post-title" href="/clay4444.github.io/posts/13325b7b/">Java的反射与动态代理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/1c38ec28/">关于内部类的那些事</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/10</span><a class="archive-post-title" href="/clay4444.github.io/posts/82b03554/">装饰者模式详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/148c5e8e/">策略模式详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span><a class="archive-post-title" href="/clay4444.github.io/posts/34ec76cc/">迭代器模式详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/f4488fab/">适配器模式详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/21</span><a class="archive-post-title" href="/clay4444.github.io/posts/db6632d/">详解关系型数据库三范式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/11</span><a class="archive-post-title" href="/clay4444.github.io/posts/dcf98c31/">maven的聚合和继承</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/09</span><a class="archive-post-title" href="/clay4444.github.io/posts/c51233f6/">JavaIO流</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/31</span><a class="archive-post-title" href="/clay4444.github.io/posts/a4b4dacb/">详解Java7中的Try-with-resource</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/e4155742/">Java异常处理模板</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/15</span><a class="archive-post-title" href="/clay4444.github.io/posts/6bb61ef6/">深入探讨Java的故障保护异常处理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/07</span><a class="archive-post-title" href="/clay4444.github.io/posts/78696dcf/">本地YUM源制作</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/04</span><a class="archive-post-title" href="/clay4444.github.io/posts/621e5041/">VMware虚拟机三种联网方法及原理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/30</span><a class="archive-post-title" href="/clay4444.github.io/posts/ecfdb360/">关于mapreduce程序开发的一些总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/29</span><a class="archive-post-title" href="/clay4444.github.io/posts/c1ee2109/">MR之mapreduce原理深入剖析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/27</span><a class="archive-post-title" href="/clay4444.github.io/posts/21f9e9c5/">MR之WordCountDemo及执行流程图</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/25</span><a class="archive-post-title" href="/clay4444.github.io/posts/a9435451/">MR之客户端提交mr程序job的流程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/63320029/">详解namenode的安全模式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span><a class="archive-post-title" href="/clay4444.github.io/posts/ac72d308/">Hadoop集群的联邦机制</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span><a class="archive-post-title" href="/clay4444.github.io/posts/d0edc1ed/">Linux常用命令</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/15</span><a class="archive-post-title" href="/clay4444.github.io/posts/a45c106d/">Hadoop集群高可用配置原理及过程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span><a class="archive-post-title" href="/clay4444.github.io/posts/442eff56/">详解Linux的链接文件</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/84f5b3e/">NIO系列之非阻塞式IO</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/04</span><a class="archive-post-title" href="/clay4444.github.io/posts/65ebcdd2/">NIO系列之缓冲区和通道</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/01</span><a class="archive-post-title" href="/clay4444.github.io/posts/a4ab48f8/">线程八锁</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/28</span><a class="archive-post-title" href="/clay4444.github.io/posts/657d2343/">经典面试题之线程按顺序交替打印</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/25</span><a class="archive-post-title" href="/clay4444.github.io/posts/2822593d/">CAS算法原子变量底层到底是如何工作的</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/20</span><a class="archive-post-title" href="/clay4444.github.io/posts/46a889d8/">Lock与synchronized的区别</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/15</span><a class="archive-post-title" href="/clay4444.github.io/posts/f9184235/">Disruptor框架</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/12</span><a class="archive-post-title" href="/clay4444.github.io/posts/282014e2/">重入锁和读写锁和分布式锁的应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/10</span><a class="archive-post-title" href="/clay4444.github.io/posts/417d070a/">concurrent包下常用类及其应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/03</span><a class="archive-post-title" href="/clay4444.github.io/posts/8b920ef3/">Executor线程池应用及其源代码解析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/31</span><a class="archive-post-title" href="/clay4444.github.io/posts/ba8be30a/">多线程的设计模式之生产者-消费者模式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/28</span><a class="archive-post-title" href="/clay4444.github.io/posts/c319249/">多线程的设计模式之Master-Worker模式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/24</span><a class="archive-post-title" href="/clay4444.github.io/posts/6d530e97/">多线程的设计模式之Future模式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/f1a00836/">并发Queue详解及其应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/20</span><a class="archive-post-title" href="/clay4444.github.io/posts/2b949ee4/">并发类容器</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/19</span><a class="archive-post-title" href="/clay4444.github.io/posts/bdf654d1/">同步类容器</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/16</span><a class="archive-post-title" href="/clay4444.github.io/posts/5d37d5dd/">集合迭代器快速失败行为及CopyOnWriteArrayList</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/15</span><a class="archive-post-title" href="/clay4444.github.io/posts/c8369a3e/">MR之倒排索引的建立</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/13</span><a class="archive-post-title" href="/clay4444.github.io/posts/db40873f/">ThreadLocal详解及其底层实现分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span><a class="archive-post-title" href="/clay4444.github.io/posts/3c6f5864/">BlockQueue队列内部实现剖析及简单模拟</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/06</span><a class="archive-post-title" href="/clay4444.github.io/posts/9a01ed74/">通过一道阿里面试题看线程间通信的概念</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/03</span><a class="archive-post-title" href="/clay4444.github.io/posts/623ba864/">关于synchronized一些容易忽略的特性</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/02</span><a class="archive-post-title" href="/clay4444.github.io/posts/2dd0f618/">Hive自定义函数和Transform</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/29</span><a class="archive-post-title" href="/clay4444.github.io/posts/5ec70f63/">Hive参数配置方式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/25</span><a class="archive-post-title" href="/clay4444.github.io/posts/73b70227/">关于Hive的Select查询</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span><a class="archive-post-title" href="/clay4444.github.io/posts/f92012d0/">Hive中的数据存储格式和基本操作</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/20</span><a class="archive-post-title" href="/clay4444.github.io/posts/e01e83db/">Hive最常用之统计报表</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span><a class="archive-post-title" href="/clay4444.github.io/posts/111e02e0/">volatile关键字</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/15</span><a class="archive-post-title" href="/clay4444.github.io/posts/16f9fb4/">单例模式的双重检查锁定+volatile</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/13</span><a class="archive-post-title" href="/clay4444.github.io/posts/e4408e09/">关于Hive的join操作</a>
        </li>
    
    </ul></div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="源码解析系列"><span class="iconfont-archer">&#xe606;</span>源码解析系列</span>
    
        <span class="sidebar-tag-name" data-tags="Flink"><span class="iconfont-archer">&#xe606;</span>Flink</span>
    
        <span class="sidebar-tag-name" data-tags="elasticsearch"><span class="iconfont-archer">&#xe606;</span>elasticsearch</span>
    
        <span class="sidebar-tag-name" data-tags="Git"><span class="iconfont-archer">&#xe606;</span>Git</span>
    
        <span class="sidebar-tag-name" data-tags="flume"><span class="iconfont-archer">&#xe606;</span>flume</span>
    
        <span class="sidebar-tag-name" data-tags="HA机制"><span class="iconfont-archer">&#xe606;</span>HA机制</span>
    
        <span class="sidebar-tag-name" data-tags="Hbase"><span class="iconfont-archer">&#xe606;</span>Hbase</span>
    
        <span class="sidebar-tag-name" data-tags="Hive"><span class="iconfont-archer">&#xe606;</span>Hive</span>
    
        <span class="sidebar-tag-name" data-tags="Java8系列"><span class="iconfont-archer">&#xe606;</span>Java8系列</span>
    
        <span class="sidebar-tag-name" data-tags="Java9系列"><span class="iconfont-archer">&#xe606;</span>Java9系列</span>
    
        <span class="sidebar-tag-name" data-tags="JavaIO流系列"><span class="iconfont-archer">&#xe606;</span>JavaIO流系列</span>
    
        <span class="sidebar-tag-name" data-tags="GC"><span class="iconfont-archer">&#xe606;</span>GC</span>
    
        <span class="sidebar-tag-name" data-tags="Java异常处理"><span class="iconfont-archer">&#xe606;</span>Java异常处理</span>
    
        <span class="sidebar-tag-name" data-tags="日志框架"><span class="iconfont-archer">&#xe606;</span>日志框架</span>
    
        <span class="sidebar-tag-name" data-tags="MapReduce"><span class="iconfont-archer">&#xe606;</span>MapReduce</span>
    
        <span class="sidebar-tag-name" data-tags="MySql"><span class="iconfont-archer">&#xe606;</span>MySql</span>
    
        <span class="sidebar-tag-name" data-tags="NIO"><span class="iconfont-archer">&#xe606;</span>NIO</span>
    
        <span class="sidebar-tag-name" data-tags="Spark"><span class="iconfont-archer">&#xe606;</span>Spark</span>
    
        <span class="sidebar-tag-name" data-tags="Spring注解驱动开发"><span class="iconfont-archer">&#xe606;</span>Spring注解驱动开发</span>
    
        <span class="sidebar-tag-name" data-tags="Storm"><span class="iconfont-archer">&#xe606;</span>Storm</span>
    
        <span class="sidebar-tag-name" data-tags="环境部署问题系列"><span class="iconfont-archer">&#xe606;</span>环境部署问题系列</span>
    
        <span class="sidebar-tag-name" data-tags="maven"><span class="iconfont-archer">&#xe606;</span>maven</span>
    
        <span class="sidebar-tag-name" data-tags="kafka"><span class="iconfont-archer">&#xe606;</span>kafka</span>
    
        <span class="sidebar-tag-name" data-tags="快学scala读书笔记"><span class="iconfont-archer">&#xe606;</span>快学scala读书笔记</span>
    
        <span class="sidebar-tag-name" data-tags="zookeeper"><span class="iconfont-archer">&#xe606;</span>zookeeper</span>
    
        <span class="sidebar-tag-name" data-tags="并发编程实战读书笔记"><span class="iconfont-archer">&#xe606;</span>并发编程实战读书笔记</span>
    
        <span class="sidebar-tag-name" data-tags="分布式"><span class="iconfont-archer">&#xe606;</span>分布式</span>
    
        <span class="sidebar-tag-name" data-tags="大数据处理算法"><span class="iconfont-archer">&#xe606;</span>大数据处理算法</span>
    
        <span class="sidebar-tag-name" data-tags="jvm"><span class="iconfont-archer">&#xe606;</span>jvm</span>
    
        <span class="sidebar-tag-name" data-tags="hdfs"><span class="iconfont-archer">&#xe606;</span>hdfs</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br>
    1、请确保node版本大于6.2<br>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="多线程编程"><span class="iconfont-archer">&#xe60a;</span>多线程编程</span>
    
        <span class="sidebar-category-name" data-categories="Java基础"><span class="iconfont-archer">&#xe60a;</span>Java基础</span>
    
        <span class="sidebar-category-name" data-categories="big-data"><span class="iconfont-archer">&#xe60a;</span>big-data</span>
    
        <span class="sidebar-category-name" data-categories="scala"><span class="iconfont-archer">&#xe60a;</span>scala</span>
    
        <span class="sidebar-category-name" data-categories="Linux"><span class="iconfont-archer">&#xe60a;</span>Linux</span>
    
        <span class="sidebar-category-name" data-categories="数据库"><span class="iconfont-archer">&#xe60a;</span>数据库</span>
    
        <span class="sidebar-category-name" data-categories="计算机网络"><span class="iconfont-archer">&#xe60a;</span>计算机网络</span>
    
        <span class="sidebar-category-name" data-categories="StreamingSystem读书笔记"><span class="iconfont-archer">&#xe60a;</span>StreamingSystem读书笔记</span>
    
        <span class="sidebar-category-name" data-categories="kafka权威指南读书笔记"><span class="iconfont-archer">&#xe60a;</span>kafka权威指南读书笔记</span>
    
        <span class="sidebar-category-name" data-categories="设计模式"><span class="iconfont-archer">&#xe60a;</span>设计模式</span>
    
        <span class="sidebar-category-name" data-categories="数据结构"><span class="iconfont-archer">&#xe60a;</span>数据结构</span>
    
        <span class="sidebar-category-name" data-categories="leetcode"><span class="iconfont-archer">&#xe60a;</span>leetcode</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/clay4444.github.io/",
        author: "clay"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/clay4444.github.io/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/clay4444.github.io/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/clay4444.github.io/scripts/share.js" async></script>    
     
    </body>
</html>


